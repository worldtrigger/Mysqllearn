# 事务

## 学习重点

- 事务是需要在同一个处理单元中执行的一系列更新处理的集合.通过使用事务,可以对数据库中的数据更新处理的提交和取消进行管理

- 事务处理的终止指令包括 COMMIT(提交处理)和 ROLLBACK(取消处理)两种

- DBMS 的事务具有原子性(A),一致性(C),隔离性(I)和持久性(D) 统称为 ACID

## 什么是事务

> 事务就是在同一个处理单元中执行的一系列更新处理的集合

```bash
事务是一个完整的业务逻辑单元,不可以再分
事务的根本作用就是里面的curd 必须都成功或者都失败 不允许一条成功，一条失败
```

## 创建事务

### 事务的语法

```bash

事务开始语句;
 DML语句①;
 DML语句②;
 DML语句③;
 . . .
事务结束语句（COMMIT或者ROLLBACK）;

```

使用事务开始语句和事务结束语句，将一系列 DML 语句（INSERT/
UPDATE/DELETE 语句）括起来，就实现了一个事务处理

### 事务开始语句

- START TRANSACTION;

```bash

START TRANSACTION;
 -- 将运动T恤的销售单价降低1000日元
 UPDATE Product
 SET sale_price = sale_price - 1000
 WHERE product_name = '运动T恤';
 -- 将T恤衫的销售单价上浮1000日元
 UPDATE Product
 SET sale_price = sale_price + 1000
 WHERE product_name = 'T恤衫';
COMMIT;

```

### COMMIT 提交处理

COMMIT 是提交事务包含的全部更新处理的结束指令。相当于文件处理中的覆盖保存,一旦提交,无法恢复到事务开始前的状态了

```bash

1. 事务开始的语句

2. 执行更新语句

3. 执行COMMIT语句

```

> 虽然我们可以不清楚事务开始的时间点，但是在事务结束时一定要仔细进行确认

### ROLLBACK ---取消处理

ROLLBACK 是取消事务包含的全部更新处理的结束指令，相当于文件处理中的放弃保存。一旦回滚，数据库就会恢复到事务开始之
前的状态。通常回滚并不会像提交那样造成大规模的数据损失。

```bash

1. 事务开始的语句

2. 执行更新语句

3. 执行ROLLBACK语句

```

- 例子

```bash

START TRANSACTION;
 -- 将运动T恤的销售单价降低1000日元
 UPDATE Product
 SET sale_price = sale_price - 1000
 WHERE product_name = '运动T恤';
 -- 将T恤衫的销售单价上浮1000日元
 UPDATE Product
 SET sale_price = sale_price + 1000
 WHERE product_name = 'T恤衫';
ROLLBACK;

```

上述事务处理执行之后，表中的数据不会发生任何改变。这是因为执
行最后一行的 ROLLBACK 之后，所有的处理都被取消了。因此，回滚执
行起来就无需像提交时那样小心翼翼了（即使是想要提交的情况，也只需
要重新执行事务处理就可以了）。

### 注意

roll back 回滚到最开始，但是它会占用主键的自增号，自增号不会随着 rollbakc 而回滚

### 隔离级别

- 第一级别 : 读未提交

对方事务还没有提交,我们当前事务可以读取到对方未提交的数据

读未提交 `存在脏读现象`

- 第二级别: 读已提交

对方事务已经提交，我们可以读取到

这种情况隔绝了`脏读`

读已提交存在的问题是不可重复读(比如早晨有，下午别人删除了)

- 第三级别 提交了我也读取不到了

这种隔离级别解决了不可重复读的级别

但这种隔离存在的问题是 读取的数据是幻象(比如对方删除了数据,但我事务没关,依旧可以读取)

- 第四级别 序列化读/串行化读(排队)

解决了所有的问题，但事务需要排队。一个事务没执行完。第二个事务不会执行

Mysql 默认级别是`第三级`
